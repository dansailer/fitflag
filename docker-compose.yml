version: '3.8'

services:
  # Flagd - Feature flag service
  flagd:
    image: ghcr.io/open-feature/flagd:latest
    container_name: fitflag-flagd
    ports:
      - "8013:8013"  # OFREP API
      - "8016:8016"  # Sync gRPC
    volumes:
      - ./flagd/config:/etc/flagd:ro
    command:
      - start
      - --cors-origin=*
      - --debug
      - --uri=file:/etc/flagd/gui.yaml
      - --uri=file:/etc/flagd/backend.yaml
      - --uri=file:/etc/flagd/nodejs.yaml
    networks:
      - fitflag-network

  # Quarkus Backend
  backend:
    build:
      context: ./src/fitflag-quarkus
      dockerfile: Dockerfile
    container_name: fitflag-backend
    ports:
      - "8081:8081"
    environment:
      - QUARKUS_HTTP_HOST=0.0.0.0
      - QUARKUS_HTTP_PORT=8081
      # CORS configuration
      - QUARKUS_HTTP_CORS=true
      - QUARKUS_HTTP_CORS_ORIGINS=*
      # Flagd connection (internal network)
      - FLAGD_HOST=flagd
      - FLAGD_PORT=8013
    networks:
      - fitflag-network

  # Node.js Backend (Calories API)
  nodejs-backend:
    build:
      context: ./src/fitflag-nodejs
      dockerfile: Dockerfile
    container_name: fitflag-nodejs-backend
    ports:
      - "8082:8082"
    environment:
      - PORT=8082
      # Flagd connection (internal network)
      - FLAGD_HOST=flagd
      - FLAGD_PORT=8013
    networks:
      - fitflag-network

  # Frontend (Vite + React)
  frontend:
    build:
      context: ./src/fitflag-frontend
      dockerfile: Dockerfile
      args:
        # Pass build-time arguments for Vite env vars
        - VITE_QUARKUS_URL=http://localhost:8081
        - VITE_FLAGD_HOST=localhost
        - VITE_FLAGD_PORT=8013
        - VITE_FLAGD_PATH_PREFIX=
        - VITE_FLAGD_TLS=false
    container_name: fitflag-frontend
    ports:
      - "8080:8080"
    networks:
      - fitflag-network

  # Debug container for network and health endpoint validation
  # debugger:
  #   image: curlimages/curl:latest
  #   container_name: fitflag-debugger
  #   command: sleep infinity
  #   networks:
  #     - fitflag-network

networks:
  fitflag-network:
    driver: bridge
